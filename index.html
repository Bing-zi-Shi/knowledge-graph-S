<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>结直肠癌筛查实施策略知识图谱</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .graph-container {
            flex: 3;
            position: relative;
        }
        .sidebar {
            flex: 1;
            padding: 20px;
            background-color: #fff;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .title {
            text-align: center;
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
        }
        .subtitle {
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .legend-rect {
            width: 15px;
            height: 15px;
            margin-right: 10px;
        }
        .legend-line {
            width: 30px;
            height: 2px;
            margin-right: 10px;
        }
        .parameter {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .node-info {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }
        .controls {
            margin-top: 20px;
        }
        .filter-group {
            margin-bottom: 15px;
        }
        select, button {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .search-box {
            width: 93%;
            padding: 8px;
            margin-bottom: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .tooltip {
            position: absolute;
            background-color: white;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 250px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="graph-container" id="graph"></div>
        <div class="sidebar">
            <div class="title">结直肠癌筛查实施策略知识图谱</div>
            
            <div class="search-box-container">
                <input type="text" id="searchBox" class="search-box" placeholder="搜索节点...">
            </div>

            <div class="controls">
                <div class="filter-group">
                    <div class="subtitle">显示节点类型</div>
                    <select id="nodeTypeFilter" multiple size="4">
                        <option value="strategy" selected>策略节点</option>
                        <option value="population" selected>人群节点</option>
                        <option value="environment" selected>环境节点</option>
                        <option value="outcome" selected>结局节点</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <div class="subtitle">策略簇过滤</div>
                    <select id="clusterFilter" multiple size="6">
                        <option value="technology" selected>技术驱动策略簇</option>
                        <option value="education" selected>教育赋能策略簇</option>
                        <option value="navigation" selected>导航支持策略簇</option>
                        <option value="clinical" selected>临床干预策略簇</option>
                        <option value="community" selected>社区参与策略簇</option>
                        <option value="system" selected>系统优化策略簇</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <div class="subtitle">关系类型过滤</div>
                    <select id="relationFilter" multiple size="5">
                        <option value="cooccurrence" selected>共现关系</option>
                        <option value="enhance" selected>增强关系</option>
                        <option value="appliesTo" selected>适用于关系</option>
                        <option value="prerequisite" selected>前提关系</option>
                        <option value="alternative" selected>替代关系</option>
                    </select>
                </div>
                
                <button id="applyFilters">应用过滤器</button>
                <button id="resetFilters">重置</button>
            </div>

            <div class="subtitle">图例</div>
            <div class="legend">
                <div class="parameter"><strong>节点类型:</strong></div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e41a1c; border-radius: 50%;"></div>
                    <span>策略节点</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #377eb8; border-radius: 0;"></div>
                    <span>人群节点</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4daf4a; border-radius: 0;"></div>
                    <span>环境节点</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #984ea3; border-radius: 0;"></div>
                    <span>结局节点</span>
                </div>
                
                <div class="parameter" style="margin-top: 15px;"><strong>策略簇:</strong></div>
                <div class="legend-item">
                    <div class="legend-rect" style="background-color: #e41a1c;"></div>
                    <span>技术驱动策略簇</span>
                </div>
                <div class="legend-item">
                    <div class="legend-rect" style="background-color: #377eb8;"></div>
                    <span>教育赋能策略簇</span>
                </div>
                <div class="legend-item">
                    <div class="legend-rect" style="background-color: #4daf4a;"></div>
                    <span>导航支持策略簇</span>
                </div>
                <div class="legend-item">
                    <div class="legend-rect" style="background-color: #984ea3;"></div>
                    <span>临床干预策略簇</span>
                </div>
                <div class="legend-item">
                    <div class="legend-rect" style="background-color: #ff7f00;"></div>
                    <span>社区参与策略簇</span>
                </div>
                <div class="legend-item">
                    <div class="legend-rect" style="background-color: #a65628;"></div>
                    <span>系统优化策略簇</span>
                </div>
                
                <div class="parameter" style="margin-top: 15px;"><strong>关系类型:</strong></div>
                <div class="legend-item">
                    <div class="legend-line" style="background-color: #999;"></div>
                    <span>共现关系</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background-color: #e41a1c;"></div>
                    <span>增强关系</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background-color: #377eb8;"></div>
                    <span>适用于关系</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background-color: #4daf4a;"></div>
                    <span>前提关系</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background-color: #984ea3;"></div>
                    <span>替代关系</span>
                </div>
            </div>
            
            <div class="subtitle">网络参数</div>
            <div class="parameters">
                <div class="parameter"><strong>节点数:</strong> 97</div>
                <div class="parameter"><strong>关系数:</strong> 1,248</div>
                <div class="parameter"><strong>图谱密度:</strong> 0.42</div>
                <div class="parameter"><strong>平均路径长度:</strong> 2.27</div>
                <div class="parameter"><strong>小世界系数:</strong> 1.83</div>
            </div>
            
            <div class="node-info" id="nodeInfo">
                <div id="nodeInfoContent"></div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script>
        // 定义数据
        const graphData = {
            nodes: [
                // 技术驱动策略簇
                { id: "mail_fit", name: "邮寄FIT套件", type: "strategy", cluster: "technology", centrality: 218.7, rank: 1 },
                { id: "sms_reminder", name: "短信提醒系统", type: "strategy", cluster: "technology", centrality: 182.3, rank: 3 },
                { id: "email_reminder", name: "电子提醒", type: "strategy", cluster: "technology", centrality: 138.5, rank: 6 },
                { id: "whatsapp", name: "WhatsApp提醒", type: "strategy", cluster: "technology", centrality: 68.4, rank: 22 },
                { id: "mobile_app", name: "移动健康应用", type: "strategy", cluster: "technology", centrality: 59.2, rank: 24 },
                { id: "video_incentive", name: "激励视频链接", type: "strategy", cluster: "technology", centrality: 45.7, rank: 28 },
                { id: "tracking_system", name: "筛查历史追踪系统", type: "strategy", cluster: "technology", centrality: 43.0, rank: 29 },
                
                // 教育赋能策略簇
                { id: "personalized_edu", name: "个性化教育材料", type: "strategy", cluster: "education", centrality: 156.8, rank: 4 },
                { id: "multimedia_edu", name: "多媒体教育", type: "strategy", cluster: "education", centrality: 92.5, rank: 11 },
                { id: "decision_aid", name: "决策辅助工具", type: "strategy", cluster: "education", centrality: 72.0, rank: 20 },
                { id: "cultural_materials", name: "文化适应性材料", type: "strategy", cluster: "education", centrality: 126.0, rank: 7 },
                { id: "literacy_materials", name: "低识字率材料设计", type: "strategy", cluster: "education", centrality: 63.0, rank: 23 },
                { id: "story_telling", name: "故事讲述干预", type: "strategy", cluster: "education", centrality: 37.5, rank: 31 },
                
                // 导航支持策略簇
                { id: "patient_navigation", name: "患者导航服务", type: "strategy", cluster: "navigation", centrality: 197.4, rank: 2 },
                { id: "telephone_counseling", name: "电话咨询指导", type: "strategy", cluster: "navigation", centrality: 143.2, rank: 5 },
                { id: "community_health_worker", name: "社区健康工作者干预", type: "strategy", cluster: "navigation", centrality: 124.9, rank: 7 },
                { id: "colonoscopy_appointment", name: "结肠镜预约援助", type: "strategy", cluster: "navigation", centrality: 91.8, rank: 12 },
                { id: "barrier_reduction", name: "减少筛查障碍干预", type: "strategy", cluster: "navigation", centrality: 87.5, rank: 14 },
                { id: "transportation", name: "交通服务支持", type: "strategy", cluster: "navigation", centrality: 29.0, rank: 36 },
                
                // 临床干预策略簇
                { id: "direct_fit", name: "直接提供FIT/筛查工具", type: "strategy", cluster: "clinical", centrality: 101.8, rank: 10 },
                { id: "physician_training", name: "医生培训项目", type: "strategy", cluster: "clinical", centrality: 107.3, rank: 9 },
                { id: "shared_decision", name: "医患共同决策", type: "strategy", cluster: "clinical", centrality: 112.6, rank: 8 },
                { id: "risk_assessment", name: "风险评估反馈", type: "strategy", cluster: "clinical", centrality: 88.6, rank: 13 },
                { id: "rapid_results", name: "筛查结果快速反馈", type: "strategy", cluster: "clinical", centrality: 36.0, rank: 33 },
                
                // 社区参与策略簇
                { id: "community_outreach", name: "社区外展活动", type: "strategy", cluster: "community", centrality: 97.0, rank: 15 },
                { id: "family_involvement", name: "家庭成员参与策略", type: "strategy", cluster: "community", centrality: 78.0, rank: 18 },
                { id: "community_design", name: "社区参与设计", type: "strategy", cluster: "community", centrality: 39.0, rank: 30 },
                { id: "success_stories", name: "筛查成功故事分享", type: "strategy", cluster: "community", centrality: 21.0, rank: 37 },
                { id: "bilingual_service", name: "双语服务提供", type: "strategy", cluster: "community", centrality: 54.0, rank: 25 },
                { id: "peer_support", name: "同伴支持与鼓励", type: "strategy", cluster: "community", centrality: 86.8, rank: 16 },
                
                // 系统优化策略簇
                { id: "simplified_process", name: "筛查流程简化", type: "strategy", cluster: "system", centrality: 83.5, rank: 17 },
                { id: "workflow_optimization", name: "医疗机构工作流优化", type: "strategy", cluster: "system", centrality: 83.0, rank: 19 },
                { id: "resource_navigation", name: "筛查资源导航地图", type: "strategy", cluster: "system", centrality: 18.0, rank: 39 },
                { id: "financial_incentives", name: "财务激励措施", type: "strategy", cluster: "system", centrality: 52.3, rank: 26 },
                { id: "non_work_hours", name: "非工作时间筛查服务", type: "strategy", cluster: "system", centrality: 32.0, rank: 34 },
                { id: "insurance_info", name: "保险覆盖信息提供", type: "strategy", cluster: "system", centrality: 13.0, rank: 41 },
                
                // 人群节点
                { id: "low_income", name: "低收入人群", type: "population", adaptability: 0.78 },
                { id: "minorities", name: "少数族裔", type: "population", adaptability: 0.85 },
                { id: "rural", name: "农村居民", type: "population", adaptability: 0.69 },
                { id: "elderly", name: "老年人群", type: "population", adaptability: 0.81 },
                { id: "low_literacy", name: "低健康素养人群", type: "population", adaptability: 0.72 },
                { id: "uninsured", name: "无保险人群", type: "population", adaptability: 0.66 },
                
                // 环境节点
                { id: "rural_community", name: "农村社区", type: "environment" },
                { id: "urban_community", name: "城市社区", type: "environment" },
                { id: "integrated_system", name: "整合医疗系统", type: "environment" },
                { id: "safety_net", name: "安全网医疗", type: "environment" },
                { id: "community_centers", name: "社区中心", type: "environment" },
                
                // 结局节点
                { id: "participation_rate", name: "筛查参与率", type: "outcome" },
                { id: "completion_rate", name: "筛查完成率", type: "outcome" },
                { id: "knowledge_attitude", name: "知识态度变化", type: "outcome" },
                { id: "screening_discussion", name: "筛查讨论率", type: "outcome" }
            ],
            links: [
                // 技术驱动策略簇内部关系
                { source: "mail_fit", target: "sms_reminder", type: "enhance", value: 3.0 },
                { source: "mail_fit", target: "email_reminder", type: "enhance", value: 2.5 },
                { source: "mail_fit", target: "whatsapp", type: "cooccurrence", value: 1.5 },
                { source: "mail_fit", target: "mobile_app", type: "alternative", value: 1.2 },
                { source: "mail_fit", target: "tracking_system", type: "cooccurrence", value: 1.3 },
                { source: "mail_fit", target: "video_incentive", type: "enhance", value: 2.2 },
                { source: "sms_reminder", target: "email_reminder", type: "cooccurrence", value: 1.8 },
                { source: "sms_reminder", target: "whatsapp", type: "alternative", value: 1.5 },
                { source: "email_reminder", target: "tracking_system", type: "cooccurrence", value: 1.2 },
                
                // 教育赋能策略簇内部关系
                { source: "personalized_edu", target: "multimedia_edu", type: "enhance", value: 2.0 },
                { source: "personalized_edu", target: "decision_aid", type: "enhance", value: 1.8 },
                { source: "personalized_edu", target: "cultural_materials", type: "cooccurrence", value: 1.5 },
                { source: "personalized_edu", target: "literacy_materials", type: "prerequisite", value: 1.7 },
                { source: "personalized_edu", target: "story_telling", type: "enhance", value: 1.3 },
                { source: "multimedia_edu", target: "literacy_materials", type: "cooccurrence", value: 1.4 },
                { source: "decision_aid", target: "shared_decision", type: "prerequisite", value: 2.1 },
                { source: "cultural_materials", target: "bilingual_service", type: "enhance", value: 1.9 },
                
                // 导航支持策略簇内部关系
                { source: "patient_navigation", target: "telephone_counseling", type: "enhance", value: 2.5 },
                { source: "patient_navigation", target: "community_health_worker", type: "cooccurrence", value: 2.0 },
                { source: "patient_navigation", target: "colonoscopy_appointment", type: "enhance", value: 1.9 },
                { source: "patient_navigation", target: "barrier_reduction", type: "prerequisite", value: 1.7 },
                { source: "patient_navigation", target: "transportation", type: "cooccurrence", value: 1.4 },
                { source: "community_health_worker", target: "barrier_reduction", type: "enhance", value: 1.6 },
                { source: "telephone_counseling", target: "colonoscopy_appointment", type: "enhance", value: 1.5 },
                
                // 临床干预策略簇内部关系
                { source: "direct_fit", target: "physician_training", type: "cooccurrence", value: 2.0 },
                { source: "direct_fit", target: "risk_assessment", type: "cooccurrence", value: 1.5 },
                { source: "physician_training", target: "shared_decision", type: "enhance", value: 2.2 },
                { source: "physician_training", target: "risk_assessment", type: "enhance", value: 1.7 },
                { source: "shared_decision", target: "risk_assessment", type: "enhance", value: 1.4 },
                { source: "direct_fit", target: "rapid_results", type: "enhance", value: 1.2 },
                
                // 社区参与策略簇内部关系
                { source: "community_outreach", target: "family_involvement", type: "enhance", value: 1.5 },
                { source: "community_outreach", target: "community_design", type: "prerequisite", value: 1.2 },
                { source: "community_outreach", target: "bilingual_service", type: "cooccurrence", value: 1.3 },
                { source: "community_outreach", target: "peer_support", type: "enhance", value: 1.6 },
                { source: "community_outreach", target: "success_stories", type: "cooccurrence", value: 1.1 },
                { source: "family_involvement", target: "peer_support", type: "enhance", value: 1.4 },
                
                // 系统优化策略簇内部关系
                { source: "simplified_process", target: "workflow_optimization", type: "cooccurrence", value: 1.2 },
                { source: "simplified_process", target: "non_work_hours", type: "enhance", value: 1.1 },
                { source: "simplified_process", target: "resource_navigation", type: "enhance", value: 1.0 },
                { source: "workflow_optimization", target: "resource_navigation", type: "cooccurrence", value: 0.9 },
                { source: "financial_incentives", target: "insurance_info", type: "cooccurrence", value: 0.8 },
                { source: "simplified_process", target: "financial_incentives", type: "alternative", value: 1.0 },
                
                // 跨策略簇关系
                { source: "mail_fit", target: "patient_navigation", type: "enhance", value: 3.5 },
                { source: "sms_reminder", target: "patient_navigation", type: "enhance", value: 3.0 },
                { source: "personalized_edu", target: "community_health_worker", type: "enhance", value: 2.7 },
                { source: "mail_fit", target: "direct_fit", type: "alternative", value: 1.5 },
                { source: "shared_decision", target: "physician_training", type: "prerequisite", value: 2.3 },
                { source: "simplified_process", target: "mail_fit", type: "enhance", value: 2.1 },
                { source: "community_outreach", target: "patient_navigation", type: "cooccurrence", value: 2.0 },
                
                // 协同效应强的策略组合
                { source: "mail_fit", target: "sms_reminder", type: "enhance", value: 3.0, synergy: 1.50 },
                { source: "sms_reminder", target: "patient_navigation", type: "enhance", value: 3.0, synergy: 1.50 },
                { source: "personalized_edu", target: "community_health_worker", type: "enhance", value: 2.7, synergy: 1.37 },
                { source: "shared_decision", target: "physician_training", type: "enhance", value: 2.3, synergy: 1.33 },
                { source: "sms_reminder", target: "simplified_process", type: "enhance", value: 2.1, synergy: 1.26 },
                
                // 策略与人群的关系
                { source: "patient_navigation", target: "low_income", type: "appliesTo", value: 2.0 },
                { source: "community_health_worker", target: "low_income", type: "appliesTo", value: 1.8 },
                { source: "cultural_materials", target: "minorities", type: "appliesTo", value: 2.2 },
                { source: "bilingual_service", target: "minorities", type: "appliesTo", value: 2.0 },
                { source: "telephone_counseling", target: "rural", type: "appliesTo", value: 1.7 },
                { source: "mail_fit", target: "rural", type: "appliesTo", value: 1.6 },
                { source: "family_involvement", target: "elderly", type: "appliesTo", value: 2.1 },
                { source: "direct_fit", target: "elderly", type: "appliesTo", value: 1.6 },
                { source: "literacy_materials", target: "low_literacy", type: "appliesTo", value: 1.9 },
                { source: "story_telling", target: "low_literacy", type: "appliesTo", value: 1.7 },
                { source: "financial_incentives", target: "uninsured", type: "appliesTo", value: 1.8 },
                { source: "community_health_worker", target: "uninsured", type: "appliesTo", value: 1.6 },
                
                // 策略与环境的关系
                { source: "mail_fit", target: "rural_community", type: "appliesTo", value: 1.5 },
                { source: "telephone_counseling", target: "rural_community", type: "appliesTo", value: 1.7 },
                { source: "community_health_worker", target: "urban_community", type: "appliesTo", value: 1.6 },
                { source: "cultural_materials", target: "urban_community", type: "appliesTo", value: 1.5 },
                { source: "physician_training", target: "integrated_system", type: "appliesTo", value: 1.8 },
                { source: "email_reminder", target: "integrated_system", type: "appliesTo", value: 1.7 },
                { source: "community_health_worker", target: "safety_net", type: "appliesTo", value: 1.9 },
                { source: "direct_fit", target: "safety_net", type: "appliesTo", value: 1.6 },
                { source: "family_involvement", target: "community_centers", type: "appliesTo", value: 1.8 },
                { source: "peer_support", target: "community_centers", type: "appliesTo", value: 1.6 },
                
                // 策略与结局的关系
                { source: "mail_fit", target: "participation_rate", type: "enhance", value: 2.5 },
                { source: "patient_navigation", target: "participation_rate", type: "enhance", value: 2.3 },
                { source: "sms_reminder", target: "completion_rate", type: "enhance", value: 2.2 },
                { source: "direct_fit", target: "completion_rate", type: "enhance", value: 2.0 },
                { source: "personalized_edu", target: "knowledge_attitude", type: "enhance", value: 2.4 },
                { source: "decision_aid", target: "knowledge_attitude", type: "enhance", value: 2.1 },
                { source: "shared_decision", target: "screening_discussion", type: "enhance", value: 2.2 },
                { source: "physician_training", target: "screening_discussion", type: "enhance", value: 2.0 }
            ]
        };

        // 创建力导向图
        const width = document.getElementById('graph').clientWidth;
        const height = document.getElementById('graph').clientHeight;
        
        // 创建SVG容器
        const svg = d3.select("#graph")
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", [0, 0, width, height])
            .attr("style", "max-width: 100%; height: auto;");
        
        // 添加箭头标记
        svg.append("defs").selectAll("marker")
            .data(["enhance", "prerequisite", "appliesTo", "alternative"])
            .enter().append("marker")
            .attr("id", d => `arrow-${d}`)
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 23)
            .attr("refY", 0)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("fill", d => {
                if (d === "enhance") return "#e41a1c";
                if (d === "prerequisite") return "#4daf4a";
                if (d === "appliesTo") return "#377eb8";
                if (d === "alternative") return "#984ea3";
                return "#999";
            })
            .attr("d", "M0,-5L10,0L0,5");
        
        // 创建力导向模拟
        const simulation = d3.forceSimulation(graphData.nodes)
            .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(d => 200 / (d.value || 1)))
            .force("charge", d3.forceManyBody().strength(-400))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("x", d3.forceX(width / 2).strength(0.1))
            .force("y", d3.forceY(height / 2).strength(0.1))
            .force("collision", d3.forceCollide().radius(d => getNodeRadius(d) + 10));

        // 绘制连接线
        const link = svg.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(graphData.links)
            .enter().append("line")
            .attr("stroke", d => {
                switch(d.type) {
                    case "enhance": return "#e41a1c";
                    case "appliesTo": return "#377eb8";
                    case "prerequisite": return "#4daf4a";
                    case "alternative": return "#984ea3";
                    default: return "#999";
                }
            })
            .attr("stroke-width", d => Math.sqrt(d.value) * 1.5)
            .attr("stroke-dasharray", d => d.type === "cooccurrence" ? "none" : "none")
            .attr("marker-end", d => {
                if (d.type === "enhance" || d.type === "prerequisite" || d.type === "appliesTo" || d.type === "alternative") {
                    return `url(#arrow-${d.type})`;
                }
                return "";
            })
            .attr("data-type", d => d.type)
            .attr("opacity", 0.6);

        // 根据节点类型和重要性获取节点半径
        function getNodeRadius(d) {
            if (d.type === "strategy") {
                // 中心度越高，节点越大
                return Math.max(8, Math.min(25, 10 + d.centrality / 20));
            } else {
                return 10; // 其他类型节点的固定大小
            }
        }

        // 获取节点颜色
        function getNodeColor(d) {
            if (d.type === "strategy") {
                switch(d.cluster) {
                    case "technology": return "#e41a1c";
                    case "education": return "#377eb8";
                    case "navigation": return "#4daf4a";
                    case "clinical": return "#984ea3";
                    case "community": return "#ff7f00";
                    case "system": return "#a65628";
                    default: return "#999";
                }
            } else if (d.type === "population") {
                return "#377eb8";
            } else if (d.type === "environment") {
                return "#4daf4a";
            } else if (d.type === "outcome") {
                return "#984ea3";
            }
            return "#999";
        }

        // 绘制节点 - 使用不同形状
        const node = svg.append("g")
            .attr("class", "nodes")
            .selectAll("g")
            .data(graphData.nodes)
            .enter().append("g")
            .attr("data-type", d => d.type)
            .attr("data-cluster", d => d.cluster || "")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));
                
        // 添加圆形（策略节点）
        node.filter(d => d.type === "strategy")
            .append("circle")
            .attr("r", getNodeRadius)
            .attr("fill", getNodeColor)
            .attr("stroke", "#fff")
            .attr("stroke-width", 1.5);
            
        // 添加方形（其他类型节点）
        node.filter(d => d.type !== "strategy")
            .append("rect")
            .attr("width", d => getNodeRadius(d) * 2)
            .attr("height", d => getNodeRadius(d) * 2)
            .attr("x", d => -getNodeRadius(d))
            .attr("y", d => -getNodeRadius(d))
            .attr("fill", getNodeColor)
            .attr("stroke", "#fff")
            .attr("stroke-width", 1.5);

        // 节点标签
        const nodeLabels = svg.append("g")
            .attr("class", "node-labels")
            .selectAll("text")
            .data(graphData.nodes)
            .enter().append("text")
            .attr("dx", 0)
            .attr("dy", d => getNodeRadius(d) + 12)
            .attr("text-anchor", "middle")
            .text(d => d.name)
            .attr("font-size", d => {
                // 核心策略节点文字稍大
                if (d.type === "strategy" && d.rank <= 5) {
                    return "11px";
                }
                return "9px";
            })
            .attr("data-type", d => d.type)
            .attr("data-cluster", d => d.cluster || "")
            .style("pointer-events", "none")
            .style("user-select", "none");

        // 设置鼠标交互事件
        node.on("mouseover", showTooltip)
            .on("mouseout", hideTooltip)
            .on("click", showNodeInfo);

        // 工具提示框
        const tooltip = d3.select("#tooltip");

        function showTooltip(event, d) {
            // 淡化其他节点和连接
            node.style("opacity", n => isConnected(d, n) ? 1 : 0.2);
            link.style("opacity", l => l.source.id === d.id || l.target.id === d.id ? 0.8 : 0.1);
            nodeLabels.style("opacity", n => isConnected(d, n) ? 1 : 0.2);
            
            // 突出显示相关节点标签
            nodeLabels.filter(n => n.id === d.id)
                .attr("font-weight", "bold")
                .attr("font-size", "12px");
            
            // 显示工具提示
            let html = `<strong>${d.name}</strong><br>`;
            
            if (d.type === "strategy") {
                html += `类型: 策略节点<br>`;
                html += `策略簇: ${getClusterName(d.cluster)}<br>`;
                html += `中心度: ${d.centrality.toFixed(1)}<br>`;
                html += `排名: ${d.rank}`;
            } else if (d.type === "population") {
                html += `类型: 人群节点<br>`;
                if (d.adaptability) {
                    html += `适应性得分: ${d.adaptability.toFixed(2)}`;
                }
            } else if (d.type === "environment") {
                html += `类型: 环境节点`;
            } else if (d.type === "outcome") {
                html += `类型: 结局节点`;
            }
            
            tooltip.html(html)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px")
                .style("opacity", 1);
        }

        function hideTooltip() {
            // 恢复所有节点和连接的透明度
            node.style("opacity", 1);
            link.style("opacity", 0.6);
            nodeLabels.style("opacity", 1);
            
            // 恢复节点标签样式
            nodeLabels.attr("font-weight", "normal")
                .attr("font-size", d => {
                    if (d.type === "strategy" && d.rank <= 5) {
                        return "11px";
                    }
                    return "9px";
                });
            
            // 隐藏工具提示
            tooltip.style("opacity", 0);
        }

        function showNodeInfo(event, d) {
            // 在侧边栏显示节点详细信息
            const nodeInfo = document.getElementById("nodeInfo");
            const nodeInfoContent = document.getElementById("nodeInfoContent");
            
            let html = `<h3>${d.name}</h3>`;
            
            if (d.type === "strategy") {
                html += `<p><strong>策略类型:</strong> ${getClusterName(d.cluster)}</p>`;
                html += `<p><strong>中心度:</strong> ${d.centrality.toFixed(1)}</p>`;
                html += `<p><strong>重要性排名:</strong> ${d.rank}</p>`;
                
                // 显示与该策略相关的人群
                const relatedPopulations = graphData.links.filter(l => 
                    (l.source.id === d.id || l.target.id === d.id) && 
                    (l.source.type === "population" || l.target.type === "population")
                );
                
                if (relatedPopulations.length > 0) {
                    html += `<p><strong>适用人群:</strong></p><ul>`;
                    relatedPopulations.forEach(l => {
                        const populationNode = l.source.type === "population" ? l.source : l.target;
                        html += `<li>${populationNode.name}</li>`;
                    });
                    html += `</ul>`;
                }
                
                // 显示与该策略协同效应高的策略
                const synergyLinks = graphData.links.filter(l => 
                    (l.source.id === d.id || l.target.id === d.id) && 
                    l.synergy && l.synergy > 1.2
                );
                
                if (synergyLinks.length > 0) {
                    html += `<p><strong>协同效应策略组合:</strong></p><ul>`;
                    synergyLinks.forEach(l => {
                        const otherNode = l.source.id === d.id ? l.target : l.source;
                        html += `<li>${otherNode.name} (协同系数: ${l.synergy.toFixed(2)})</li>`;
                    });
                    html += `</ul>`;
                }
            } else if (d.type === "population") {
                html += `<p><strong>节点类型:</strong> 人群特征</p>`;
                
                if (d.adaptability) {
                    html += `<p><strong>适应性得分:</strong> ${d.adaptability.toFixed(2)}</p>`;
                }
                
                // 显示适用于该人群的策略
                const relatedStrategies = graphData.links.filter(l => 
                    (l.source.id === d.id || l.target.id === d.id) && 
                    (l.source.type === "strategy" || l.target.type === "strategy")
                );
                
                if (relatedStrategies.length > 0) {
                    html += `<p><strong>适用策略:</strong></p><ul>`;
                    relatedStrategies.sort((a, b) => {
                        const strategyA = a.source.type === "strategy" ? a.source : a.target;
                        const strategyB = b.source.type === "strategy" ? b.source : b.target;
                        return strategyA.rank - strategyB.rank;
                    }).forEach(l => {
                        const strategyNode = l.source.type === "strategy" ? l.source : l.target;
                        html += `<li>${strategyNode.name}</li>`;
                    });
                    html += `</ul>`;
                }
            } else if (d.type === "environment") {
                html += `<p><strong>节点类型:</strong> 实施环境</p>`;
                
                // 显示适用于该环境的策略
                const relatedStrategies = graphData.links.filter(l => 
                    (l.source.id === d.id || l.target.id === d.id) && 
                    (l.source.type === "strategy" || l.target.type === "strategy")
                );
                
                if (relatedStrategies.length > 0) {
                    html += `<p><strong>推荐策略:</strong></p><ul>`;
                    relatedStrategies.sort((a, b) => {
                        const strategyA = a.source.type === "strategy" ? a.source : a.target;
                        const strategyB = b.source.type === "strategy" ? b.source : b.target;
                        return strategyA.rank - strategyB.rank;
                    }).forEach(l => {
                        const strategyNode = l.source.type === "strategy" ? l.source : l.target;
                        html += `<li>${strategyNode.name}</li>`;
                    });
                    html += `</ul>`;
                }
            } else if (d.type === "outcome") {
                html += `<p><strong>节点类型:</strong> 结局指标</p>`;
                
                // 显示影响该结局的策略
                const relatedStrategies = graphData.links.filter(l => 
                    (l.source.id === d.id || l.target.id === d.id) && 
                    (l.source.type === "strategy" || l.target.type === "strategy")
                );
                
                if (relatedStrategies.length > 0) {
                    html += `<p><strong>影响策略:</strong></p><ul>`;
                    relatedStrategies.sort((a, b) => {
                        const strategyA = a.source.type === "strategy" ? a.source : a.target;
                        const strategyB = b.source.type === "strategy" ? b.source : b.target;
                        return strategyA.rank - strategyB.rank;
                    }).forEach(l => {
                        const strategyNode = l.source.type === "strategy" ? l.source : l.target;
                        html += `<li>${strategyNode.name}</li>`;
                    });
                    html += `</ul>`;
                }
            }
            
            nodeInfoContent.innerHTML = html;
            nodeInfo.style.display = "block";
        }

        // 检查两个节点是否相连
        function isConnected(a, b) {
            if (a.id === b.id) return true;
            return graphData.links.some(l => 
                (l.source.id === a.id && l.target.id === b.id) || 
                (l.source.id === b.id && l.target.id === a.id)
            );
        }
        
        // 获取策略簇的中文名
        function getClusterName(cluster) {
            switch(cluster) {
                case "technology": return "技术驱动策略簇";
                case "education": return "教育赋能策略簇";
                case "navigation": return "导航支持策略簇";
                case "clinical": return "临床干预策略簇";
                case "community": return "社区参与策略簇";
                case "system": return "系统优化策略簇";
                default: return cluster;
            }
        }

        // 力导向图更新函数
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            // 更新节点组的位置
            node.attr("transform", d => {
                d.x = Math.max(getNodeRadius(d), Math.min(width - getNodeRadius(d), d.x));
                d.y = Math.max(getNodeRadius(d), Math.min(height - getNodeRadius(d), d.y));
                return `translate(${d.x},${d.y})`;
            });
                
            nodeLabels
                .attr("x", d => d.x)
                .attr("y", d => d.y);
        });

        // 拖拽功能
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // 搜索功能
        document.getElementById("searchBox").addEventListener("input", function() {
            const searchTerm = this.value.toLowerCase();
            
            if (searchTerm === "") {
                node.style("stroke", "#fff").style("stroke-width", 1.5);
                return;
            }
            
            node.each(function(d) {
                const element = d3.select(this);
                if (d.name.toLowerCase().includes(searchTerm)) {
                    element.style("stroke", "#ff0")
                           .style("stroke-width", 3);
                } else {
                    element.style("stroke", "#fff")
                           .style("stroke-width", 1.5);
                }
            });
        });

        // 过滤器功能
        document.getElementById("applyFilters").addEventListener("click", applyFilters);
        document.getElementById("resetFilters").addEventListener("click", resetFilters);

        function applyFilters() {
            // 获取选中的节点类型
            const nodeTypeFilter = Array.from(document.getElementById("nodeTypeFilter").selectedOptions)
                .map(option => option.value);
            
            // 获取选中的策略簇
            const clusterFilter = Array.from(document.getElementById("clusterFilter").selectedOptions)
                .map(option => option.value);
            
            // 获取选中的关系类型
            const relationFilter = Array.from(document.getElementById("relationFilter").selectedOptions)
                .map(option => option.value);
            
            // 过滤节点
            node.style("display", d => {
                if (!nodeTypeFilter.includes(d.type)) return "none";
                if (d.type === "strategy" && !clusterFilter.includes(d.cluster)) return "none";
                return null;
            });
            
            nodeLabels.style("display", d => {
                if (!nodeTypeFilter.includes(d.type)) return "none";
                if (d.type === "strategy" && !clusterFilter.includes(d.cluster)) return "none";
                return null;
            });
            
            // 过滤连接线
            link.style("display", d => {
                // 如果连接的任一节点不可见，则隐藏连接
                if (node.filter(n => n.id === d.source.id).style("display") === "none") return "none";
                if (node.filter(n => n.id === d.target.id).style("display") === "none") return "none";
                
                // 过滤关系类型
                if (!relationFilter.includes(d.type)) return "none";
                
                return null;
            });
            
            // 重启力导向模拟以调整布局
            simulation.alpha(0.3).restart();
        }

        function resetFilters() {
            // 重置选择框
            document.getElementById("nodeTypeFilter").querySelectorAll("option").forEach(option => {
                option.selected = true;
            });
            
            document.getElementById("clusterFilter").querySelectorAll("option").forEach(option => {
                option.selected = true;
            });
            
            document.getElementById("relationFilter").querySelectorAll("option").forEach(option => {
                option.selected = true;
            });
            
            // 显示所有节点和连接
            node.style("display", null);
            nodeLabels.style("display", null);
            link.style("display", null);
            
            // 重启力导向模拟
            simulation.alpha(0.3).restart();
        }
    </script>
</body>
</html>